# yaml
name: CI / Release

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'
  create:
    # catches when a tag is created on the remote
    tags:
      - 'v*'
  release:
    types: [published]
  workflow_dispatch: {}

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    env:
      GO111MODULE: 'on'
      GOCACHE: ${{ runner.temp }}/gocache
      GOMODCACHE: ${{ runner.temp }}/gomodcache
    strategy:
      fail-fast: false
      matrix:
        go-version: [ 1.18, 1.20 ]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ matrix.go-version }}

      - name: Prepare cache folders
        run: |
          mkdir -p "${GOCACHE}" "${GOMODCACHE}"

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.GOCACHE }}
            ${{ env.GOMODCACHE }}
          key: ${{ runner.os }}-go-${{ matrix.go-version }}-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-${{ matrix.go-version }}-

      - name: Download modules
        run: go mod download

      - name: Format check
        run: test -z "$(gofmt -l .)"

      - name: Run tests
        run: go test -v ./...

  release:
    name: Release
    runs-on: ubuntu-latest
    needs: test
    if: |
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')) ||
      (github.event_name == 'create' && github.ref_type == 'tag') ||
      (github.event_name == 'release' && github.event.action == 'published') ||
      (github.event_name == 'workflow_dispatch')
    permissions:
      id-token: write
      contents: write
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: 1.20

      - name: Build cross-platform artifacts (local script)
        run: |
          chmod +x build/build.sh
          # pass the tag name as version if available, fallback to 'ci'
          VERSION=${GITHUB_REF_NAME:-ci}
          ./build/build.sh "$VERSION"
        env:
          GITHUB_REF_NAME: ${{ github.ref_name }}

      - name: Upload artifacts to workflow (for debugging)
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: build/dist

      - name: Create GitHub Release and attach artifacts (fallback)
        if: always()
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.ref_name }}
          files: build/dist/**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Try GoReleaser (optional, will run if installed by action)
        uses: goreleaser/goreleaser-action@v3
        with:
          version: latest
          args: release --rm-dist
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COSIGN_EXPERIMENTAL: 1

      - name: Install cosign (optional, used when signing images)
        uses: sigstore/cosign-installer@main
        with:
          cosign-release: 'v1.14.0'

      - name: Build and publish container image (optional)
        if: startsWith(github.ref, 'refs/tags/')
        uses: imjasonh/setup-ko@v0.4

      - name: Publish and sign image (optional)
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          IMAGE=$(ko publish ./ --tags "${{ github.ref_name }}") || true
          echo "Published image: $IMAGE"
          if [ -n "$IMAGE" ]; then
            cosign sign --keyless "$IMAGE" || true
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COSIGN_EXPERIMENTAL: 1
